---
name    : observer-ci-pipeline
run-name: Build, Tag and Push new image observer
on      :
  push:
    branches:
    - master
    paths:
    - apps/observer/Dockerfile
    - apps/observer/**
    - .github/workflows/observer-ci.yml
    - '!apps/observer/.devcontainer/**'

jobs    :
  handle-docker-image:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Image Directory
      id: checkout
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          apps/observer
    - name: Generate Date
      id: date
      run: echo "TAG_DATE=$(date +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"
    - name: Set up QEMU
      id: qemu
      uses: docker/setup-qemu-action@v3
      with:
        platforms: all
    - name: Login to Docker Hub
      id: login-docker-hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_TOKEN }}
    - name: Use Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:master
          network=host
        install: true
    - name: export PYPI_TOKEN
      id: pytoken
      run: export PYPI_TOKEN=${{ secrets.PYPI_TOKEN }}
    - name: Build and push
      id: docker_build
      uses: docker/build-push-action@v5
      with:
        platforms: linux/amd64,linux/arm64
        file: apps/observer/Dockerfile
        context: apps/observer
        secrets: |
          "PYPI_TOKEN=${{ secrets.PYPI_TOKEN }}"
        push: true
        tags: |
          ${{ secrets.DOCKER_USER }}/observer:${{ steps.date.outputs.TAG_DATE }}.${{ github.run_number }}
          ${{ secrets.DOCKER_USER }}/observer:latest
